<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End of Day Report</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom input field styling */
        .input-field {
            transition: all 0.2s ease-in-out;
            background-color: transparent;
            border-bottom: 2px solid transparent;
        }
        .input-field:focus {
            outline: none;
            border-bottom-color: #38a169; /* Green-500 */
        }
        .input-field::placeholder {
            color: #a0aec0; /* Gray-400 */
        }
        .summary-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 15px rgba(0, 0, 0, 0.05);
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

    <!-- Login Container -->
    <div id="login-container" class="max-w-md w-full p-8 bg-white rounded-lg shadow-xl text-center hidden">
        <div class="flex justify-center mb-6">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-green-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5l-6 6m0 0l6 6m-6-6h12" />
            </svg>
        </div>
        <h1 class="text-3xl font-bold text-green-800 mb-2">Welcome!</h1>
        <p class="text-gray-600 mb-6">
            Sign in to start managing your daily reports.
        </p>
        <button id="google-sign-in-button" class="flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md w-full transition-all duration-200">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 48 48">
                <path d="M24 9.5c3.54 0 6.75 1.22 9.27 3.29l6.09-6.09C34.61 4.72 29.6 3 24 3 15.17 3 7.71 8.08 4.25 15.68l7.15 5.62C12.3 15.42 17.65 9.5 24 9.5z" fill="#4285F4"/>
                <path d="M46.75 24c0-1.57-.15-3.09-.4-4.57H24v8.91h12.71c-.57 3.01-2.46 5.56-5.26 7.23l7.15 5.62c4.13-7.77 6.55-17.15 6.55-27.19z" fill="#34A853"/>
                <path d="M12.3 32.58c-1.28-.73-2.42-1.77-3.41-2.99l-7.15 5.62c2.04 4.54 5.92 8.1 10.59 9.87C17.75 44.5 22.84 45 27.24 44.5l-7.15-5.62c-2.31-1.45-4.26-3.42-5.79-5.79z" fill="#FBBC05"/>
                <path d="M24 19.5c2.47 0 4.69.82 6.46 2.15l6.09-6.09C30.75 11.22 27.54 10 24 10c-3.21 0-6.17 1.29-8.3 3.39l7.15 5.62c1.8-.73 3.86-1.11 6.15-1.11z" fill="#EA4335"/>
            </svg>
            Sign in with Google
        </button>
    </div>

    <!-- Main Application Container -->
    <div id="main-app-container" class="max-w-6xl mx-auto p-4 sm:p-6 md:p-8 font-inter hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8">
            <!-- Header Section -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <img id="user-photo" src="" alt="User Profile" class="hidden w-16 h-16 rounded-full border-2 border-green-500 shadow-md">
                    <div class="text-center md:text-left">
                        <h1 class="text-2xl font-bold text-green-800 mb-1">
                            <input
                                type="text"
                                id="user-name"
                                placeholder="Enter your name"
                                class="p-1 input-field text-2xl font-bold text-green-800 bg-transparent border-none focus:ring-0"
                                disabled
                            />
                        </h1>
                        <p class="text-lg text-green-700">
                            <input
                                type="text"
                                id="user-position"
                                placeholder="Enter your position"
                                class="p-1 input-field text-lg text-green-700 bg-transparent border-none focus:ring-0"
                                disabled
                            />
                        </p>
                        <p id="user-id-display" class="text-xs text-gray-500 mt-1 break-all hidden"></p>
                    </div>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <h2 id="current-date" class="text-2xl font-bold text-green-800"></h2>
                    <div
                        id="auth-status-display"
                        class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200"
                    >
                        Signed Out
                    </div>
                </div>
            </header>

            <!-- Loading/Saving Indicator -->
            <div id="loading-indicator" class="flex items-center justify-center p-2 text-sm font-semibold text-gray-600 bg-gray-50 rounded-lg mb-4 hidden">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="loading-message">Loading...</span>
            </div>

            <!-- Performance Summary Section - Today -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Today's Performance</h3>
                <div id="today-performance-cards" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
            </div>

            <!-- Performance Summary Section - Overall -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Overall Performance</h3>
                <div id="overall-performance-cards" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
            </div>

            <!-- Add Task Section -->
            <div id="add-task-section" class="bg-gray-50 p-6 rounded-lg shadow-md mb-8 hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Add New Task</h3>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input
                        type="text"
                        id="new-task-activity"
                        placeholder="Activity/Task"
                        class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                    />
                    <select
                        id="new-task-status"
                        class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 flex-shrink-0"
                    >
                        <option value="Not Yet Started">Not Yet Started</option>
                        <option value="Work in Progress">Work in Progress</option>
                        <option value="Pending Approval">Pending Approval</option>
                        <option value="Done">Done</option>
                    </select>
                    <button
                        id="add-task-button"
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 flex-shrink-0"
                    >
                        Add Task
                    </button>
                </div>
                <textarea
                    id="highlights-textarea"
                    placeholder="Add highlights for today..."
                    rows="3"
                    class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 mb-4"
                ></textarea>
                <div class="flex space-x-4">
                    <button
                        id="undo-button"
                        class="bg-gray-500 text-white hover:bg-gray-600 px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Undo Last Action
                    </button>
                    <button
                        id="redo-button"
                        class="bg-gray-500 text-white hover:bg-gray-600 px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Redo Last Action
                    </button>
                </div>
            </div>

            <!-- Daily Reports Section -->
            <div>
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Daily Reports</h3>
                <div id="reports-container" class="space-y-6">
                    <!-- Reports will be dynamically injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <p id="modal-message" class="text-lg font-semibold mb-4"></p>
            <div class="flex justify-end space-x-4">
                <button
                    id="modal-cancel-btn"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg"
                >
                    No
                </button>
                <button
                    id="modal-confirm-btn"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg"
                >
                    Yes
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            query,
            onSnapshot,
            addDoc,
            doc,
            setDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & INITIALIZATION ---
        // Firebase instances
        let db;
        let auth;
        let userId = null;
        let reports = [];
        let userName = '';
        let userPosition = '';
        let highlights = '';
        let isSaving = false;
        let modalCallback = null;

        // History management
        let historyStack = [];
        let redoStack = [];
        const MAX_HISTORY_DEPTH = 10;

        // HTML element references
        const loginContainerEl = document.getElementById('login-container');
        const mainAppContainerEl = document.getElementById('main-app-container');
        const googleSignInButton = document.getElementById('google-sign-in-button');
        const userPhotoEl = document.getElementById('user-photo');
        const userNameEl = document.getElementById('user-name');
        const userPositionEl = document.getElementById('user-position');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const authStatusDisplay = document.getElementById('auth-status-display');
        const currentDateEl = document.getElementById('current-date');
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        const loadingMessageEl = document.getElementById('loading-message');
        const todayPerformanceEl = document.getElementById('today-performance-cards');
        const overallPerformanceEl = document.getElementById('overall-performance-cards');
        const addTaskSectionEl = document.getElementById('add-task-section');
        const newTaskActivityEl = document.getElementById('new-task-activity');
        const newTaskStatusEl = document.getElementById('new-task-status');
        const addTaskButton = document.getElementById('add-task-button');
        const highlightsTextarea = document.getElementById('highlights-textarea');
        const reportsContainerEl = document.getElementById('reports-container');
        const undoButton = document.getElementById('undo-button');
        const redoButton = document.getElementById('redo-button');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessageEl = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        // The following variables are provided by the Canvas environment for Firestore access.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        /**
         * Pushes the current state to the history stack for undo functionality.
         */
        const pushToHistory = () => {
            const currentState = { reports: [...reports], userName, userPosition, highlights };
            if (historyStack.length > 0 && JSON.stringify(historyStack[historyStack.length - 1]) === JSON.stringify(currentState)) {
                return;
            }
            historyStack.push(currentState);
            if (historyStack.length > MAX_HISTORY_DEPTH) {
                historyStack.shift();
            }
            redoStack = [];
            updateUndoRedoButtons();
        };

        /**
         * Restores the application state from the history stack.
         */
        const handleUndo = () => {
            if (historyStack.length > 0) {
                const lastState = historyStack.pop();
                redoStack.push({ reports: [...reports], userName, userPosition, highlights });
                reports = lastState.reports;
                userName = lastState.userName;
                userPosition = lastState.userPosition;
                highlights = lastState.highlights;
                renderApp();
                updateUndoRedoButtons();
            }
        };

        /**
         * Restores the application state from the redo stack.
         */
        const handleRedo = () => {
            if (redoStack.length > 0) {
                const nextState = redoStack.pop();
                historyStack.push({ reports: [...reports], userName, userPosition, highlights });
                reports = nextState.reports;
                userName = nextState.userName;
                userPosition = nextState.userPosition;
                highlights = nextState.highlights;
                renderApp();
                updateUndoRedoButtons();
            }
        };

        /**
         * Updates the disabled state of the undo/redo buttons.
         */
        const updateUndoRedoButtons = () => {
            undoButton.disabled = historyStack.length === 0 || isSaving || !userId;
            redoButton.disabled = redoStack.length === 0 || isSaving || !userId;
        };

        /**
         * Shows a confirmation modal with a message and a callback function.
         * @param {string} message - The message to display in the modal.
         * @param {Function} callback - The function to call if the user confirms.
         */
        const showConfirmationModal = (message, callback) => {
            modalMessageEl.textContent = message;
            modalCallback = callback;
            confirmationModal.classList.remove('hidden');
        };

        /**
         * Hides the confirmation modal.
         */
        const hideConfirmationModal = () => {
            confirmationModal.classList.add('hidden');
            modalCallback = null;
        };
        
        /**
         * Initializes Firebase and sets up the authentication listener.
         */
        const initializeFirebase = async () => {
            try {
                if (!firebaseConfig.apiKey) {
                  showConfirmationModal("Firebase config is missing or invalid.", () => {});
                  return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // The auth listener will handle showing the correct UI
                setupAuthListener();
                
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showConfirmationModal('An error occurred initializing Firebase. Check the console for details.', () => {});
            }
        };

        /**
         * Handles the Google Sign-In process using a popup.
         */
        const handleGoogleSignIn = async () => {
            const provider = new GoogleAuthProvider();
            try {
                showLoading("Signing in with Google...");
                const result = await signInWithPopup(auth, provider);
                // User is signed in. The onAuthStateChanged listener will handle UI updates.
                console.log("Successfully signed in with Google:", result.user.displayName);
                hideLoading();
            } catch (error) {
                console.error("Error during Google Sign-In:", error);
                hideLoading();
                let errorMessage = 'An error occurred during Google Sign-In.';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in popup was closed. Please try again.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = 'This domain is not authorized. Please add it to your Firebase console.';
                }
                showConfirmationModal(errorMessage, () => {});
            }
        };

        /**
         * Sets up the Firebase authentication listener.
         */
        const setupAuthListener = () => {
            if (!auth) return;
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    updateUIForUser(user);
                    setupFirestoreListeners();
                } else {
                    userId = null;
                    updateUIForGuest();
                    reports = [];
                    renderReports();
                }
            });
        };

        /**
         * Sets up the Firestore listeners for reports and user data.
         */
        const setupFirestoreListeners = () => {
            if (!db || !userId) return;
            showLoading("Loading reports...");
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            const unsubscribeUserData = onSnapshot(userDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userName = data.name || '';
                    userPosition = data.position || '';
                    userNameEl.value = userName;
                    userPositionEl.value = userPosition;
                } else {
                    // Create a user document if it doesn't exist.
                    const initialName = auth.currentUser.displayName || '';
                    const initialPosition = '';
                    await setDoc(userDocRef, { name: initialName, position: initialPosition });
                }
            }, (error) => {
                console.error("Error listening to user data:", error);
            });

            // Listener for reports
            const reportsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reports');
            const q = query(reportsCollectionRef);
            const unsubscribeReports = onSnapshot(q, (querySnapshot) => {
                const reportsArray = [];
                querySnapshot.forEach((doc) => {
                    reportsArray.push({ id: doc.id, ...doc.data() });
                });
                reports = reportsArray.sort((a, b) => new Date(b.date) - new Date(a.date));
                const today = new Date().toISOString().split('T')[0];
                const todayReport = reports.find(report => report.date === today);
                highlights = todayReport ? todayReport.highlights : '';
                highlightsTextarea.value = highlights;
                renderApp();
                hideLoading();
            }, (error) => {
                console.error("Error listening to reports:", error);
                hideLoading();
            });

            // Clean up listeners when component unmounts or user signs out
            return () => {
                unsubscribeUserData();
                unsubscribeReports();
            };
        };

        /**
         * Updates the UI to show user-specific information.
         * @param {object} user - The Firebase User object.
         */
        const updateUIForUser = (user) => {
            // Check if the user has a photo URL before setting the src
            if (user.photoURL) {
                userPhotoEl.src = user.photoURL;
                userPhotoEl.classList.remove('hidden');
            } else {
                userPhotoEl.classList.add('hidden');
            }
            userNameEl.disabled = false;
            userPositionEl.disabled = false;
            userIdDisplayEl.textContent = `User ID: ${user.uid}`;
            userIdDisplayEl.classList.remove('hidden');
            authStatusDisplay.textContent = 'Signed In';
            authStatusDisplay.classList.remove('bg-gray-200', 'text-gray-800');
            authStatusDisplay.classList.add('bg-green-500', 'text-white');
            addTaskSectionEl.classList.remove('hidden');
            newTaskActivityEl.disabled = false;
            newTaskStatusEl.disabled = false;
            addTaskButton.disabled = false;
            highlightsTextarea.disabled = false;
            loginContainerEl.classList.add('hidden');
            mainAppContainerEl.classList.remove('hidden');
            updateUndoRedoButtons();
        };

        /**
         * Updates the UI for a guest/signed-out user.
         */
        const updateUIForGuest = () => {
            userPhotoEl.classList.add('hidden');
            userNameEl.value = '';
            userPositionEl.value = '';
            userNameEl.disabled = true;
            userPositionEl.disabled = true;
            userIdDisplayEl.classList.add('hidden');
            authStatusDisplay.textContent = 'Signed Out';
            authStatusDisplay.classList.remove('bg-green-500', 'text-white');
            authStatusDisplay.classList.add('bg-gray-200', 'text-gray-800');
            addTaskSectionEl.classList.add('hidden');
            reportsContainerEl.innerHTML = '';
            loginContainerEl.classList.remove('hidden');
            mainAppContainerEl.classList.add('hidden');
            updateUndoRedoButtons();
        };

        /**
         * Shows a loading message and indicator.
         * @param {string} message - The message to display.
         */
        const showLoading = (message) => {
            loadingMessageEl.textContent = message;
            loadingIndicatorEl.classList.remove('hidden');
        };

        /**
         * Hides the loading indicator.
         */
        const hideLoading = () => {
            loadingIndicatorEl.classList.add('hidden');
        };

        /**
         * Renders the application UI.
         */
        const renderApp = () => {
            renderReports();
            renderPerformanceCards();
        };

        /**
         * Renders the daily reports in the UI.
         */
        const renderReports = () => {
            reportsContainerEl.innerHTML = '';
            if (reports.length === 0) {
                reportsContainerEl.innerHTML = `<p class="text-gray-500 text-center">No reports found. Add a new task to get started!</p>`;
                return;
            }
            reports.forEach(report => {
                const reportEl = document.createElement('div');
                reportEl.classList.add('bg-gray-50', 'p-6', 'rounded-lg', 'shadow-md');
                reportEl.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-gray-800">${report.date}</h4>
                        <button class="delete-report-btn text-red-500 hover:text-red-700 transition-colors" data-report-id="${report.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.25c-1.102 0-2-.884-2.042-1.996l-.38-8.218m7.596 0A2.25 2.25 0 0110.5 11.25H1.5a.75.75 0 010-1.5h15.75c.414 0 .75-.336.75-.75v-1.5a.75.75 0 00-.75-.75H9.75M5.25 7.5a.75.75 0 011.5 0v1.5a.75.75 0 01-1.5 0v-1.5z" />
                            </svg>
                        </button>
                    </div>
                    ${report.highlights ? `<p class="text-gray-600 mb-4 whitespace-pre-wrap"><strong>Highlights:</strong> ${report.highlights}</p>` : ''}
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${report.tasks.map((task, index) => `
                                <tr data-report-id="${report.id}" data-task-index="${index}" class="hover:bg-gray-100 transition-colors duration-150">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.activity}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <select class="status-select p-1 rounded-md text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-green-500 ${getStatusColorClass(task.status)}">
                                            <option value="Not Yet Started" ${task.status === 'Not Yet Started' ? 'selected' : ''}>Not Yet Started</option>
                                            <option value="Work in Progress" ${task.status === 'Work in Progress' ? 'selected' : ''}>Work in Progress</option>
                                            <option value="Pending Approval" ${task.status === 'Pending Approval' ? 'selected' : ''}>Pending Approval</option>
                                            <option value="Done" ${task.status === 'Done' ? 'selected' : ''}>Done</option>
                                        </select>
                                        <button class="delete-task-btn ml-2 text-red-400 hover:text-red-600 transition-colors" data-task-index="${index}">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                reportsContainerEl.appendChild(reportEl);
            });
        };

        /**
         * Renders the performance summary cards.
         */
        const renderPerformanceCards = () => {
            if (!userId) {
                todayPerformanceEl.innerHTML = '';
                overallPerformanceEl.innerHTML = '';
                return;
            }
            const today = new Date().toISOString().split('T')[0];
            const todayReport = reports.find(r => r.date === today);
            
            // Calculate today's stats
            const todayDone = todayReport ? todayReport.tasks.filter(t => t.status === 'Done').length : 0;
            const todayInProgress = todayReport ? todayReport.tasks.filter(t => t.status === 'Work in Progress').length : 0;
            const todayPending = todayReport ? todayReport.tasks.filter(t => t.status === 'Pending Approval').length : 0;
            const todayNotStarted = todayReport ? todayReport.tasks.filter(t => t.status === 'Not Yet Started').length : 0;

            const todayTotal = todayReport ? todayReport.tasks.length : 0;
            const todayCompletedPercentage = todayTotal > 0 ? (todayDone / todayTotal) * 100 : 0;

            todayPerformanceEl.innerHTML = `
                ${createPerformanceCard('Tasks Done Today', todayDone, 'bg-green-100 text-green-800')}
                ${createPerformanceCard('Work in Progress Today', todayInProgress, 'bg-yellow-100 text-yellow-800')}
                ${createPerformanceCard('Pending Approval Today', todayPending, 'bg-orange-100 text-orange-800')}
                ${createPerformanceCard('Not Yet Started Today', todayNotStarted, 'bg-blue-100 text-blue-800')}
            `;

            // Calculate overall stats
            const overallTasks = reports.flatMap(r => r.tasks);
            const overallDone = overallTasks.filter(t => t.status === 'Done').length;
            const overallInProgress = overallTasks.filter(t => t.status === 'Work in Progress').length;
            const overallPending = overallTasks.filter(t => t.status === 'Pending Approval').length;
            const overallNotStarted = overallTasks.filter(t => t.status === 'Not Yet Started').length;
            const overallTotal = overallTasks.length;
            const overallCompletedPercentage = overallTotal > 0 ? (overallDone / overallTotal) * 100 : 0;

            overallPerformanceEl.innerHTML = `
                ${createPerformanceCard('Total Tasks Done', overallDone, 'bg-green-100 text-green-800')}
                ${createPerformanceCard('Total Work in Progress', overallInProgress, 'bg-yellow-100 text-yellow-800')}
                ${createPerformanceCard('Total Pending Approval', overallPending, 'bg-orange-100 text-orange-800')}
                ${createPerformanceCard('Total Not Yet Started', overallNotStarted, 'bg-blue-100 text-blue-800')}
            `;
        };

        /**
         * Creates an HTML string for a performance card.
         * @param {string} title - The title of the card.
         * @param {number} value - The value to display.
         * @param {string} colorClass - The Tailwind CSS class for background and text color.
         * @returns {string} The HTML string for the card.
         */
        const createPerformanceCard = (title, value, colorClass) => {
            return `
                <div class="summary-card p-4 rounded-lg shadow-sm ${colorClass} transition-all duration-200">
                    <p class="text-sm font-semibold">${title}</p>
                    <p class="text-3xl font-bold mt-2">${value}</p>
                </div>
            `;
        };
        
        // --- DATA MANAGEMENT FUNCTIONS ---

        /**
         * Saves user profile data to Firestore.
         */
        const saveProfile = async () => {
            if (!userId || isSaving) return;
            isSaving = true;
            try {
                showLoading("Saving profile...");
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                await setDoc(userDocRef, { name: userName, position: userPosition }, { merge: true });
                hideLoading();
                pushToHistory();
            } catch (e) {
                console.error("Error saving profile:", e);
                hideLoading();
            } finally {
                isSaving = false;
            }
        };

        /**
         * Adds a new task to the current day's report.
         * @param {string} activity - The task activity.
         * @param {string} status - The initial status of the task.
         */
        const addTask = async (activity, status) => {
            if (!userId || isSaving) return;
            isSaving = true;
            try {
                showLoading("Adding task...");
                const today = new Date().toISOString().split('T')[0];
                const todayReport = reports.find(r => r.date === today);

                if (todayReport) {
                    // Update existing report
                    const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', todayReport.id);
                    const updatedTasks = [...todayReport.tasks, { activity, status }];
                    await setDoc(reportDocRef, { tasks: updatedTasks }, { merge: true });
                } else {
                    // Create new report
                    const reportsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reports');
                    await addDoc(reportsCollectionRef, {
                        date: today,
                        tasks: [{ activity, status }],
                        highlights: ''
                    });
                }
                newTaskActivityEl.value = '';
                newTaskStatusEl.value = 'Not Yet Started';
                hideLoading();
                pushToHistory();
            } catch (e) {
                console.error("Error adding task:", e);
                hideLoading();
            } finally {
                isSaving = false;
            }
        };

        /**
         * Updates the status of a specific task.
         * @param {string} reportId - The ID of the report.
         * @param {number} taskIndex - The index of the task in the tasks array.
         * @param {string} newStatus - The new status.
         */
        const updateTaskStatus = async (reportId, taskIndex, newStatus) => {
            if (!userId || isSaving) return;
            isSaving = true;
            try {
                const report = reports.find(r => r.id === reportId);
                if (report) {
                    showLoading("Updating task status...");
                    const updatedTasks = [...report.tasks];
                    updatedTasks[taskIndex].status = newStatus;
                    const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', reportId);
                    await setDoc(reportDocRef, { tasks: updatedTasks }, { merge: true });
                }
                hideLoading();
                pushToHistory();
            } catch (e) {
                console.error("Error updating task status:", e);
                hideLoading();
            } finally {
                isSaving = false;
            }
        };

        /**
         * Deletes a task from a report.
         * @param {string} reportId - The ID of the report.
         * @param {number} taskIndex - The index of the task to delete.
         */
        const deleteTask = async (reportId, taskIndex) => {
             if (!userId || isSaving) return;
            isSaving = true;
            try {
                showLoading("Deleting task...");
                const report = reports.find(r => r.id === reportId);
                if (report) {
                    const updatedTasks = report.tasks.filter((_, index) => index !== taskIndex);
                    const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', reportId);
                    await setDoc(reportDocRef, { tasks: updatedTasks }, { merge: true });
                }
                hideLoading();
                pushToHistory();
            } catch (e) {
                console.error("Error deleting task:", e);
                hideLoading();
            } finally {
                isSaving = false;
            }
        };

        /**
         * Deletes an entire report.
         * @param {string} reportId - The ID of the report to delete.
         */
        const deleteReport = async (reportId) => {
            if (!userId || isSaving) return;
            isSaving = true;
            try {
                showLoading("Deleting report...");
                const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', reportId);
                await deleteDoc(reportDocRef);
                hideLoading();
                pushToHistory();
            } catch (e) {
                console.error("Error deleting report:", e);
                hideLoading();
            } finally {
                isSaving = false;
            }
        };

        /**
         * Updates the highlights for a report.
         * @param {string} newHighlights - The new highlights text.
         */
        const updateHighlights = async (newHighlights) => {
            if (!userId || isSaving) return;
            isSaving = true;
            try {
                const today = new Date().toISOString().split('T')[0];
                const todayReport = reports.find(r => r.date === today);

                if (todayReport) {
                    const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', todayReport.id);
                    await setDoc(reportDocRef, { highlights: newHighlights }, { merge: true });
                } else if (newHighlights.trim() !== '') {
                    // Create a new report with just the highlights if one doesn't exist
                    const reportsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reports');
                    await addDoc(reportsCollectionRef, {
                        date: today,
                        tasks: [],
                        highlights: newHighlights
                    });
                }
                hideLoading();
                pushToHistory();
            } catch (e) {
                console.error("Error updating highlights:", e);
                hideLoading();
            } finally {
                isSaving = false;
            }
        };

        // --- EVENT LISTENERS ---
        const setupEventListeners = () => {
            // New listener for the Google Sign-In button
            googleSignInButton.addEventListener('click', handleGoogleSignIn);
            
            // Listen for profile field changes with a debounce
            let debounceTimer;
            const handleProfileChange = (event) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    userName = userNameEl.value;
                    userPosition = userPositionEl.value;
                    saveProfile();
                }, 500);
            };
            userNameEl.addEventListener('input', handleProfileChange);
            userPositionEl.addEventListener('input', handleProfileChange);

            // Listen for adding a new task
            addTaskButton.addEventListener('click', () => {
                const activity = newTaskActivityEl.value.trim();
                const status = newTaskStatusEl.value;
                if (activity) {
                    addTask(activity, status);
                } else {
                    showConfirmationModal('Please enter an activity for the new task.', () => {});
                }
            });

            // Listen for status changes on reports, and delete buttons
            reportsContainerEl.addEventListener('change', (event) => {
                const { target } = event;
                if (target.classList.contains('status-select')) {
                    const row = target.closest('tr');
                    const reportId = row.dataset.reportId;
                    const taskIndex = parseInt(row.dataset.taskIndex, 10);
                    updateTaskStatus(reportId, taskIndex, target.value);
                }
            });

            reportsContainerEl.addEventListener('click', (event) => {
                const { target } = event;
                const deleteReportButton = target.closest('.delete-report-btn');
                const deleteTaskButton = target.closest('.delete-task-btn');
                
                if (deleteReportButton) {
                    const reportId = deleteReportButton.dataset.reportId;
                    showConfirmationModal('Are you sure you want to delete this entire report?', () => {
                        deleteReport(reportId);
                        hideConfirmationModal();
                    });
                } else if (deleteTaskButton) {
                    const row = deleteTaskButton.closest('tr');
                    const reportId = row.dataset.reportId;
                    const taskIndex = parseInt(deleteTaskButton.dataset.taskIndex, 10);
                    showConfirmationModal('Are you sure you want to delete this task?', () => {
                        deleteTask(reportId, taskIndex);
                        hideConfirmationModal();
                    });
                }
            });

            // Listen for highlight changes with a debounce
            let highlightsDebounceTimer;
            highlightsTextarea.addEventListener('input', () => {
                clearTimeout(highlightsDebounceTimer);
                highlightsDebounceTimer = setTimeout(() => {
                    updateHighlights(highlightsTextarea.value);
                }, 500);
            });

            // Undo/Redo buttons
            undoButton.addEventListener('click', handleUndo);
            redoButton.addEventListener('click', handleRedo);

            // Modal buttons
            modalConfirmBtn.addEventListener('click', () => {
                if (modalCallback) modalCallback();
            });
            modalCancelBtn.addEventListener('click', hideConfirmationModal);
        };
        
        /**
         * Gets the status color class for a given status.
         * @param {string} status - The task status.
         * @returns {string} The Tailwind CSS class for the status color.
         */
        const getStatusColorClass = (status) => {
            switch (status) {
                case 'Done': return 'bg-green-100 text-green-800';
                case 'Pending Approval': return 'bg-orange-100 text-orange-800';
                case 'Work in Progress': return 'bg-yellow-100 text-yellow-800';
                case 'Not Yet Started': return 'bg-blue-100 text-blue-800';
                default: return '';
            }
        };

        // --- MAIN INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Display today's date
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDateEl.textContent = today.toLocaleDateString('en-US', options);

            // Initial UI state
            setupEventListeners();
            initializeFirebase();
        });
    </script>
</body>
</html>
