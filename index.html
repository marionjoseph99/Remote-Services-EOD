<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End of Day Report</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom input field styling */
        .input-field {
            transition: all 0.2s ease-in-out;
            background-color: transparent;
            border-bottom: 2px solid transparent;
        }
        .input-field:focus {
            outline: none;
            border-bottom-color: #38a169; /* Green-500 */
        }
        .input-field::placeholder {
            color: #a0aec0; /* Gray-400 */
        }
        .summary-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 15px rgba(0, 0, 0, 0.05);
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

    <!-- Login Container -->
    <div id="login-container" class="max-w-md w-full p-8 bg-white rounded-lg shadow-xl text-center hidden">
        <div class="flex justify-center mb-6">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-green-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5l-6 6m0 0l6 6m-6-6h12" />
            </svg>
        </div>
        <h1 class="text-3xl font-bold text-green-800 mb-2">Welcome!</h1>
        <p class="text-gray-600 mb-6">Please sign in with your Google account to access your daily reports.</p>
        <button
            id="sign-in-button"
            class="w-full flex items-center justify-center gap-2 bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50"
        >
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                <path fill="#4285F4" d="M24 9.5c3.33 0 5.67 1.44 6.78 2.53l5.58-5.58C32.14 2.8 28.53 1 24 1 15.66 1 8.5 5.86 4.6 13.5l6.57 5.08C12.39 12.8 17.65 9.5 24 9.5z"/>
                <path fill="#34A853" d="M46.75 24c0-1.52-.13-2.97-.37-4.38H24v8.83h12.86c-.56 3.01-2.31 5.5-4.99 7.2L38.4 41.5C43.1 37.1 46.75 31.06 46.75 24z"/>
                <path fill="#FBBC05" d="M9.47 28.66c-.46-1.34-.73-2.77-.73-4.16s.27-2.82.73-4.16L3.1 15.13C1.12 19.34 0 24 0 24s1.12 4.66 3.1 8.87l6.37-5.21z"/>
                <path fill="#EA4335" d="M24 42c6.64 0 12.22-2.18 16.29-5.94l-6.57-5.08c-2.48 1.63-5.6 2.59-9.72 2.59-6.35 0-11.61-3.3-13.4-8.03L4.6 32.5C8.5 40.14 15.66 45 24 45c3.8 0 7.4-1 10.51-2.7z"/>
            </svg>
            Sign In with Google
        </button>
        <div id="login-loading" class="mt-4 text-sm text-gray-500 flex items-center justify-center hidden">
            <svg class="animate-spin h-5 w-5 mr-3 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Redirecting to sign-in...
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="main-app-container" class="max-w-6xl mx-auto p-4 sm:p-6 md:p-8 font-inter hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8">
            <!-- Header Section -->
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <img id="user-photo" src="" alt="User Profile" class="hidden w-16 h-16 rounded-full border-2 border-green-500 shadow-md">
                    <div class="text-center md:text-left">
                        <h1 class="text-2xl font-bold text-green-800 mb-1">
                            <input
                                type="text"
                                id="user-name"
                                placeholder="Enter your name"
                                class="p-1 input-field text-2xl font-bold text-green-800 bg-transparent border-none focus:ring-0"
                                disabled
                            />
                        </h1>
                        <p class="text-lg text-green-700">
                            <input
                                type="text"
                                id="user-position"
                                placeholder="Enter your position"
                                class="p-1 input-field text-lg text-green-700 bg-transparent border-none focus:ring-0"
                                disabled
                            />
                        </p>
                        <p id="user-id-display" class="text-xs text-gray-500 mt-1 break-all hidden"></p>
                    </div>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <h2 id="current-date" class="text-2xl font-bold text-green-800"></h2>
                    <!-- Auth status is now displayed, not an interactive button -->
                    <div
                        id="auth-status-display"
                        class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200"
                    >
                        Initializing...
                    </div>
                </div>
            </header>

            <!-- Loading/Saving Indicator -->
            <div id="loading-indicator" class="flex items-center justify-center p-2 text-sm font-semibold text-gray-600 bg-gray-50 rounded-lg mb-4 hidden">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span id="loading-message">Loading...</span>
            </div>

            <!-- Performance Summary Section - Today -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Today's Performance</h3>
                <div id="today-performance-cards" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
            </div>

            <!-- Performance Summary Section - Overall -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Overall Performance</h3>
                <div id="overall-performance-cards" class="grid grid-cols-2 sm:grid-cols-4 gap-4"></div>
            </div>

            <!-- Add Task Section -->
            <div id="add-task-section" class="bg-gray-50 p-6 rounded-lg shadow-md mb-8 hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Add New Task</h3>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input
                        type="text"
                        id="new-task-activity"
                        placeholder="Activity/Task"
                        class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                    />
                    <select
                        id="new-task-status"
                        class="p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 flex-shrink-0"
                    >
                        <option value="Not Yet Started">Not Yet Started</option>
                        <option value="Work in Progress">Work in Progress</option>
                        <option value="Pending Approval">Pending Approval</option>
                        <option value="Done">Done</option>
                    </select>
                    <button
                        id="add-task-button"
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 flex-shrink-0"
                    >
                        Add Task
                    </button>
                </div>
                <textarea
                    id="highlights-textarea"
                    placeholder="Add highlights for today..."
                    rows="3"
                    class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 mb-4"
                ></textarea>
                <div class="flex space-x-4">
                    <button
                        id="undo-button"
                        class="bg-gray-500 text-white hover:bg-gray-600 px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Undo Last Action
                    </button>
                    <button
                        id="redo-button"
                        class="bg-gray-500 text-white hover:bg-gray-600 px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        Redo Last Action
                    </button>
                </div>
            </div>

            <!-- Daily Reports Section -->
            <div>
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Daily Reports</h3>
                <div id="reports-container" class="space-y-6">
                    <!-- Reports will be dynamically injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <p id="modal-message" class="text-lg font-semibold mb-4"></p>
            <div class="flex justify-end space-x-4">
                <button
                    id="modal-cancel-btn"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg"
                >
                    No
                </button>
                <button
                    id="modal-confirm-btn"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg"
                >
                    Yes
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            query,
            onSnapshot,
            addDoc,
            doc,
            setDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & INITIALIZATION ---
        // Firebase instances
        let db;
        let auth;
        let userId = null;
        let reports = [];
        let userName = '';
        let userPosition = '';
        let highlights = '';
        let isSaving = false;
        let modalCallback = null;

        // History management
        let historyStack = [];
        let redoStack = [];
        const MAX_HISTORY_DEPTH = 10;

        // HTML element references
        const loginContainerEl = document.getElementById('login-container');
        const mainAppContainerEl = document.getElementById('main-app-container');
        const signInButton = document.getElementById('sign-in-button');
        const loginLoadingEl = document.getElementById('login-loading');
        const userPhotoEl = document.getElementById('user-photo');
        const userNameEl = document.getElementById('user-name');
        const userPositionEl = document.getElementById('user-position');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const authStatusDisplay = document.getElementById('auth-status-display');
        const currentDateEl = document.getElementById('current-date');
        const loadingIndicatorEl = document.getElementById('loading-indicator');
        const loadingMessageEl = document.getElementById('loading-message');
        const todayPerformanceEl = document.getElementById('today-performance-cards');
        const overallPerformanceEl = document.getElementById('overall-performance-cards');
        const addTaskSectionEl = document.getElementById('add-task-section');
        const newTaskActivityEl = document.getElementById('new-task-activity');
        const newTaskStatusEl = document.getElementById('new-task-status');
        const addTaskButton = document.getElementById('add-task-button');
        const highlightsTextarea = document.getElementById('highlights-textarea');
        const reportsContainerEl = document.getElementById('reports-container');
        const undoButton = document.getElementById('undo-button');
        const redoButton = document.getElementById('redo-button');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalMessageEl = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        /**
         * Pushes the current state to the history stack for undo functionality.
         */
        const pushToHistory = () => {
            const currentState = { reports: [...reports], userName, userPosition, highlights };
            if (historyStack.length > 0 && JSON.stringify(historyStack[historyStack.length - 1]) === JSON.stringify(currentState)) {
                return;
            }
            historyStack.push(currentState);
            if (historyStack.length > MAX_HISTORY_DEPTH) {
                historyStack.shift();
            }
            redoStack = [];
            updateUndoRedoButtons();
        };

        /**
         * Restores the application state from the history stack.
         */
        const handleUndo = () => {
            if (historyStack.length > 0) {
                const lastState = historyStack.pop();
                redoStack.push({ reports: [...reports], userName, userPosition, highlights });
                reports = lastState.reports;
                userName = lastState.userName;
                userPosition = lastState.userPosition;
                highlights = lastState.highlights;
                renderApp();
                updateUndoRedoButtons();
            }
        };

        /**
         * Restores the application state from the redo stack.
         */
        const handleRedo = () => {
            if (redoStack.length > 0) {
                const nextState = redoStack.pop();
                historyStack.push({ reports: [...reports], userName, userPosition, highlights });
                reports = nextState.reports;
                userName = nextState.userName;
                userPosition = nextState.userPosition;
                highlights = nextState.highlights;
                renderApp();
                updateUndoRedoButtons();
            }
        };

        /**
         * Updates the disabled state of the undo/redo buttons.
         */
        const updateUndoRedoButtons = () => {
            undoButton.disabled = historyStack.length === 0 || isSaving || !userId;
            redoButton.disabled = redoStack.length === 0 || isSaving || !userId;
        };

        /**
         * Shows a confirmation modal with a message and a callback function.
         * @param {string} message - The message to display in the modal.
         * @param {Function} callback - The function to call if the user confirms.
         */
        const showConfirmationModal = (message, callback) => {
            modalMessageEl.textContent = message;
            modalCallback = callback;
            confirmationModal.classList.remove('hidden');
        };

        /**
         * Hides the confirmation modal.
         */
        const hideConfirmationModal = () => {
            confirmationModal.classList.add('hidden');
            modalCallback = null;
        };
        
        /**
         * Initializes Firebase and sets up the authentication listener.
         */
        const initializeFirebase = async () => {
            try {
                if (typeof __firebase_config !== 'undefined') {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // The auth listener will handle showing the correct UI
                    setupAuthListener();
                } else {
                    console.error("Firebase config not found.");
                    // Fallback for local development
                    loadingIndicatorEl.classList.add('hidden');
                    // showConfirmationModal('Firebase configuration not found. The app will run in a limited, non-persistent mode.', () => {});
                    loginContainerEl.classList.remove('hidden'); // Show login screen even if no firebase
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loadingIndicatorEl.classList.add('hidden');
                showConfirmationModal('An error occurred initializing Firebase. Check the console for details.', () => {});
            }
        };

        /**
         * Handles the sign-in process using Google Sign-In with a popup.
         */
        const handleSignIn = async () => {
            loginLoadingEl.classList.remove('hidden');
            signInButton.disabled = true;
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error during Google sign-in:", error);
                loginLoadingEl.classList.add('hidden');
                signInButton.disabled = false;
                showConfirmationModal(`Sign-in failed: ${error.message}`, () => {});
            }
        };
        
        /**
         * Sets up the Firebase authentication listener.
         */
        const setupAuthListener = () => {
            if (!auth) return;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    updateUIForUser(user);
                    setupFirestoreListeners();
                    loginContainerEl.classList.add('hidden');
                    mainAppContainerEl.classList.remove('hidden');
                } else {
                    userId = null;
                    updateUIForGuest();
                    reports = [];
                    renderReports();
                    loginContainerEl.classList.remove('hidden');
                    mainAppContainerEl.classList.add('hidden');
                    loginLoadingEl.classList.add('hidden');
                    signInButton.disabled = false;
                    loadingIndicatorEl.classList.add('hidden');
                }
            });
        };

        /**
         * Sets up the Firestore listeners for reports and user data.
         */
        const setupFirestoreListeners = () => {
            if (!db || !userId) return;

            showLoading("Loading reports...");
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            
            const unsubscribeUserData = onSnapshot(userDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userName = data.name || '';
                    userPosition = data.position || '';
                    userNameEl.value = userName;
                    userPositionEl.value = userPosition;
                } else {
                    // Create a user document if it doesn't exist. Use the display name from Google auth.
                    const user = auth.currentUser;
                    const initialName = user.displayName || '';
                    const initialPosition = '';
                    await setDoc(userDocRef, { name: initialName, position: initialPosition });
                }
            }, (error) => {
                console.error("Error listening to user data:", error);
            });

            // Listener for reports
            const reportsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reports');
            const q = query(reportsCollectionRef);

            const unsubscribeReports = onSnapshot(q, (querySnapshot) => {
                const reportsArray = [];
                querySnapshot.forEach((doc) => {
                    reportsArray.push({ id: doc.id, ...doc.data() });
                });
                reports = reportsArray.sort((a, b) => new Date(b.date) - new Date(a.date));

                const today = new Date().toISOString().split('T')[0];
                const todayReport = reports.find(report => report.date === today);
                highlights = todayReport ? todayReport.highlights : '';
                highlightsTextarea.value = highlights;

                renderApp();
                hideLoading();
            }, (error) => {
                console.error("Error listening to reports:", error);
                hideLoading();
            });

            // Clean up listeners when component unmounts or user signs out
            return () => {
                unsubscribeUserData();
                unsubscribeReports();
            };
        };

        /**
         * Updates the UI to show user-specific information.
         * @param {object} user - The Firebase User object.
         */
        const updateUIForUser = (user) => {
            // Check if the user has a photo URL before setting the src
            if (user.photoURL) {
                userPhotoEl.src = user.photoURL;
                userPhotoEl.classList.remove('hidden');
            } else {
                 userPhotoEl.classList.add('hidden');
            }
            userNameEl.disabled = false;
            userPositionEl.disabled = false;
            userIdDisplayEl.textContent = `User ID: ${user.uid}`;
            userIdDisplayEl.classList.remove('hidden');
            authStatusDisplay.textContent = 'Signed In';
            authStatusDisplay.classList.remove('bg-gray-200', 'text-gray-800');
            authStatusDisplay.classList.add('bg-green-500', 'text-white');
            addTaskSectionEl.classList.remove('hidden');
            newTaskActivityEl.disabled = false;
            newTaskStatusEl.disabled = false;
            addTaskButton.disabled = false;
            highlightsTextarea.disabled = false;
            updateUndoRedoButtons();
        };

        /**
         * Updates the UI for a guest/signed-out user.
         */
        const updateUIForGuest = () => {
            userPhotoEl.classList.add('hidden');
            userNameEl.value = '';
            userPositionEl.value = '';
            userNameEl.disabled = true;
            userPositionEl.disabled = true;
            userIdDisplayEl.classList.add('hidden');
            authStatusDisplay.textContent = 'Signed Out';
            authStatusDisplay.classList.remove('bg-green-500', 'text-white');
            authStatusDisplay.classList.add('bg-gray-200', 'text-gray-800');
            addTaskSectionEl.classList.add('hidden');
            newTaskActivityEl.disabled = true;
            newTaskStatusEl.disabled = true;
            addTaskButton.disabled = true;
            highlightsTextarea.disabled = true;
            updateUndoRedoButtons();
        };

        /**
         * Renders the entire application UI based on the current state.
         */
        const renderApp = () => {
            renderPerformanceCards();
            renderReports();
            updateUndoRedoButtons();
        };

        /**
         * Calculates and renders the performance summary cards.
         */
        const renderPerformanceCards = () => {
            const calculatePerformance = (taskList) => {
                const counts = { 'Not Yet Started': 0, 'Work in Progress': 0, 'Pending Approval': 0, 'Done': 0 };
                taskList.forEach(task => {
                    if (counts[task.status] !== undefined) counts[task.status]++;
                });
                return counts;
            };

            const getStatusColorClass = (status) => {
                switch (status) {
                    case 'Done': return 'bg-green-100 text-green-800';
                    case 'Pending Approval': return 'bg-orange-100 text-orange-800';
                    case 'Work in Progress': return 'bg-yellow-100 text-yellow-800';
                    case 'Not Yet Started': return 'bg-blue-100 text-blue-800';
                    default: return '';
                }
            };
            
            const renderCards = (containerEl, performanceData) => {
                containerEl.innerHTML = '';
                const statuses = ['Not Yet Started', 'Work in Progress', 'Pending Approval', 'Done'];
                statuses.forEach(status => {
                    const card = document.createElement('div');
                    card.className = `summary-card p-4 rounded-lg shadow-md transition-transform duration-200 ease-in-out hover:translate-y-[-3px] ${getStatusColorClass(status)}`;
                    card.innerHTML = `
                        <p class="text-sm font-medium mb-1">${status}</p>
                        <p class="text-3xl font-bold">${performanceData[status] || 0}</p>
                    `;
                    containerEl.appendChild(card);
                });
            };

            const today = new Date().toISOString().split('T')[0];
            const todayReport = reports.find(report => report.date === today);
            const todayTasks = todayReport ? todayReport.tasks : [];
            const overallTasks = reports.flatMap(report => report.tasks);

            renderCards(todayPerformanceEl, calculatePerformance(todayTasks));
            renderCards(overallPerformanceEl, calculatePerformance(overallTasks));
        };

        /**
         * Renders the daily reports.
         */
        const renderReports = () => {
            reportsContainerEl.innerHTML = '';
            if (reports.length === 0) {
                reportsContainerEl.innerHTML = `<p class="text-gray-500 text-center">${userId ? "No tasks reported yet. Add your first task above!" : "Please sign in to view your daily reports."}</p>`;
                return;
            }

            reports.forEach(report => {
                const reportDiv = document.createElement('div');
                reportDiv.className = 'bg-white border border-gray-200 rounded-lg shadow-sm p-4';
                
                const sortedTasks = [...(report.tasks || [])].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let tasksHtml = sortedTasks.map((task, index) => {
                    // Find the original index for Firestore updates
                    const originalTaskIndex = report.tasks.findIndex(t => t.timestamp === task.timestamp && t.activity === task.activity);
                    const statusColorClass = getStatusColorClass(task.status);
                    
                    return `
                        <tr data-report-id="${report.id}" data-task-index="${originalTaskIndex}">
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                                <span class="task-activity">${task.activity}</span>
                                <input type="text" class="edit-task-input hidden p-1 text-sm border-gray-300 rounded-md w-full" value="${task.activity}" />
                            </td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                                <select class="task-status p-1 text-sm rounded-md font-medium ${statusColorClass}">
                                    <option value="Not Yet Started" ${task.status === 'Not Yet Started' ? 'selected' : ''}>Not Yet Started</option>
                                    <option value="Work in Progress" ${task.status === 'Work in Progress' ? 'selected' : ''}>Work in Progress</option>
                                    <option value="Pending Approval" ${task.status === 'Pending Approval' ? 'selected' : ''}>Pending Approval</option>
                                    <option value="Done" ${task.status === 'Done' ? 'selected' : ''}>Done</option>
                                </select>
                            </td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 flex space-x-2">
                                <button class="edit-task-btn bg-gray-500 text-white hover:bg-gray-600 px-2 py-1 text-xs rounded-md">Edit</button>
                                <button class="save-task-btn bg-green-500 text-white hover:bg-green-600 px-2 py-1 text-xs rounded-md hidden">Save</button>
                                <button class="cancel-task-btn bg-gray-500 text-white hover:bg-gray-600 px-2 py-1 text-xs rounded-md hidden">Cancel</button>
                                <button class="delete-task-btn bg-red-500 text-white hover:bg-red-600 px-2 py-1 text-xs rounded-md">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                const highlightsHtml = report.highlights ? `
                    <div class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200">
                        <p class="font-semibold text-gray-700 mb-1">Highlights:</p>
                        <p class="text-sm text-gray-600">${report.highlights}</p>
                    </div>
                ` : '';

                reportDiv.innerHTML = `
                    <h4 class="text-lg font-bold text-gray-800 mb-3 pb-2 border-b border-gray-200">
                        Date: ${new Date(report.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                    </h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity / Task</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tasksHtml}
                            </tbody>
                        </table>
                    </div>
                    ${highlightsHtml}
                `;
                reportsContainerEl.appendChild(reportDiv);
            });
        };

        /**
         * Shows the loading indicator with a message.
         * @param {string} message - The message to display.
         */
        const showLoading = (message) => {
            isSaving = true;
            loadingMessageEl.textContent = message;
            loadingIndicatorEl.classList.remove('hidden');
            updateUndoRedoButtons();
        };

        /**
         * Hides the loading indicator.
         */
        const hideLoading = () => {
            isSaving = false;
            loadingIndicatorEl.classList.add('hidden');
            updateUndoRedoButtons();
        };
        
        /**
         * Adds a new report/task to Firestore.
         */
        const handleAddTask = async () => {
            if (!db || !userId) return;

            const activity = newTaskActivityEl.value.trim();
            if (!activity) {
                showConfirmationModal("Task activity cannot be empty.", () => {});
                return;
            }

            showLoading("Adding task...");
            pushToHistory();

            const today = new Date().toISOString().split('T')[0];
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const reportsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reports');

            try {
                const todayReport = reports.find(report => report.date === today);
                const newTask = {
                    activity,
                    status: newTaskStatusEl.value,
                    timestamp: new Date().toISOString(),
                };

                if (todayReport) {
                    // Update existing report
                    const updatedTasks = [newTask, ...todayReport.tasks];
                    const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', todayReport.id);
                    await setDoc(reportDocRef, { tasks: updatedTasks }, { merge: true });
                } else {
                    // Create a new report
                    const newReport = {
                        date: today,
                        tasks: [newTask],
                        highlights: highlights,
                    };
                    await addDoc(reportsCollectionRef, newReport);
                }
                newTaskActivityEl.value = '';
                newTaskStatusEl.value = 'Not Yet Started';
            } catch (error) {
                console.error("Error adding task:", error);
            } finally {
                hideLoading();
            }
        };
        
        /**
         * Updates a user's name or position in Firestore.
         * @param {string} field - The field to update ('name' or 'position').
         * @param {string} value - The new value.
         */
        const handleUpdateUserInfo = async (field, value) => {
            if (!db || !userId || value === (field === 'name' ? userName : userPosition)) return;

            showLoading(`Updating ${field}...`);
            pushToHistory();

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
            try {
                await setDoc(userDocRef, { [field]: value }, { merge: true });
            } catch (error) {
                console.error(`Error updating user ${field}:`, error);
            } finally {
                hideLoading();
            }
        };

        /**
         * Updates the highlights for today's report in Firestore.
         */
        const handleUpdateHighlights = async () => {
            if (!db || !userId || highlightsTextarea.value === highlights) return;
            const newHighlights = highlightsTextarea.value;
            
            showLoading("Saving highlights...");
            pushToHistory();

            const today = new Date().toISOString().split('T')[0];
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const reportsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reports');

            try {
                const todayReport = reports.find(report => report.date === today);
                if (todayReport) {
                    const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', todayReport.id);
                    await setDoc(reportDocRef, { highlights: newHighlights }, { merge: true });
                } else {
                    const newReport = {
                        date: today,
                        tasks: [],
                        highlights: newHighlights,
                    };
                    await addDoc(reportsCollectionRef, newReport);
                }
            } catch (error) {
                console.error("Error updating highlights:", error);
            } finally {
                hideLoading();
            }
        };

        /**
         * Updates a task's status in Firestore.
         * @param {string} reportId - The ID of the report document.
         * @param {number} taskIndex - The index of the task in the tasks array.
         * @param {string} newStatus - The new status of the task.
         */
        const updateTaskStatus = async (reportId, taskIndex, newStatus) => {
            if (!db || !userId) return;

            showLoading("Updating task status...");
            pushToHistory();

            try {
                const report = reports.find(r => r.id === reportId);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', reportId);
                const updatedTasks = [...report.tasks];
                updatedTasks[taskIndex] = { ...updatedTasks[taskIndex], status: newStatus };
                await setDoc(reportDocRef, { tasks: updatedTasks }, { merge: true });
            } catch (error) {
                console.error("Error updating task status:", error);
            } finally {
                hideLoading();
            }
        };

        /**
         * Updates a task's activity in Firestore.
         * @param {string} reportId - The ID of the report document.
         * @param {number} taskIndex - The index of the task in the tasks array.
         * @param {string} newActivity - The new activity text.
         */
        const updateTaskActivity = async (reportId, taskIndex, newActivity) => {
            if (!db || !userId) return;

            showLoading("Saving task activity...");
            pushToHistory();

            try {
                const report = reports.find(r => r.id === reportId);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', reportId);
                const updatedTasks = [...report.tasks];
                updatedTasks[taskIndex] = { ...updatedTasks[taskIndex], activity: newActivity.trim() };
                await setDoc(reportDocRef, { tasks: updatedTasks }, { merge: true });
            } catch (error) {
                console.error("Error updating task activity:", error);
            } finally {
                hideLoading();
            }
        };

        /**
         * Deletes a task from a report in Firestore.
         * @param {string} reportId - The ID of the report document.
         * @param {number} taskIndex - The index of the task to delete.
         */
        const deleteTask = async (reportId, taskIndex) => {
            if (!db || !userId) return;

            showConfirmationModal("Are you sure you want to delete this task?", async () => {
                showLoading("Deleting task...");
                pushToHistory();

                try {
                    const report = reports.find(r => r.id === reportId);
                    const updatedTasks = report.tasks.filter((_, index) => index !== taskIndex);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const reportDocRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', reportId);

                    if (updatedTasks.length === 0) {
                        await deleteDoc(reportDocRef);
                    } else {
                        await setDoc(reportDocRef, { tasks: updatedTasks }, { merge: true });
                    }
                } catch (error) {
                    console.error("Error deleting task:", error);
                } finally {
                    hideLoading();
                }
            });
        };

        /**
         * Sets up all event listeners for the application.
         */
        const setupEventListeners = () => {
            // Login page listener
            signInButton.addEventListener('click', handleSignIn);

            // User info blur listeners
            userNameEl.addEventListener('blur', (e) => handleUpdateUserInfo('name', e.target.value));
            userPositionEl.addEventListener('blur', (e) => handleUpdateUserInfo('position', e.target.value));

            // Add task button listener
            addTaskButton.addEventListener('click', handleAddTask);

            // Highlights blur listener
            highlightsTextarea.addEventListener('blur', handleUpdateHighlights);

            // Undo/Redo button listeners
            undoButton.addEventListener('click', handleUndo);
            redoButton.addEventListener('click', handleRedo);

            // Confirmation modal listeners
            modalConfirmBtn.addEventListener('click', () => {
                if (modalCallback) {
                    modalCallback();
                }
                hideConfirmationModal();
            });
            modalCancelBtn.addEventListener('click', hideConfirmationModal);

            // Event delegation for dynamically created report elements
            reportsContainerEl.addEventListener('click', (e) => {
                const target = e.target;
                const row = target.closest('tr');
                if (!row) return;

                const reportId = row.dataset.reportId;
                const taskIndex = parseInt(row.dataset.taskIndex, 10);

                if (target.classList.contains('delete-task-btn')) {
                    deleteTask(reportId, taskIndex);
                } else if (target.classList.contains('edit-task-btn')) {
                    const activitySpan = row.querySelector('.task-activity');
                    const activityInput = row.querySelector('.edit-task-input');
                    const editBtn = row.querySelector('.edit-task-btn');
                    const saveBtn = row.querySelector('.save-task-btn');
                    const cancelBtn = row.querySelector('.cancel-task-btn');
                    const statusSelect = row.querySelector('.task-status');

                    activitySpan.classList.add('hidden');
                    activityInput.classList.remove('hidden');
                    activityInput.value = activitySpan.textContent;
                    editBtn.classList.add('hidden');
                    saveBtn.classList.remove('hidden');
                    cancelBtn.classList.remove('hidden');
                    statusSelect.disabled = true;

                } else if (target.classList.contains('save-task-btn')) {
                    const activityInput = row.querySelector('.edit-task-input');
                    updateTaskActivity(reportId, taskIndex, activityInput.value);

                    const activitySpan = row.querySelector('.task-activity');
                    const editBtn = row.querySelector('.edit-task-btn');
                    const saveBtn = row.querySelector('.save-task-btn');
                    const cancelBtn = row.querySelector('.cancel-task-btn');
                    const statusSelect = row.querySelector('.task-status');

                    activitySpan.classList.remove('hidden');
                    activityInput.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                    saveBtn.classList.add('hidden');
                    cancelBtn.classList.add('hidden');
                    statusSelect.disabled = false;
                } else if (target.classList.contains('cancel-task-btn')) {
                    const activitySpan = row.querySelector('.task-activity');
                    const activityInput = row.querySelector('.edit-task-input');
                    const editBtn = row.querySelector('.edit-task-btn');
                    const saveBtn = row.querySelector('.save-task-btn');
                    const cancelBtn = row.querySelector('.cancel-task-btn');
                    const statusSelect = row.querySelector('.task-status');

                    activitySpan.classList.remove('hidden');
                    activityInput.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                    saveBtn.classList.add('hidden');
                    cancelBtn.classList.add('hidden');
                    statusSelect.disabled = false;
                }
            });

            reportsContainerEl.addEventListener('change', (e) => {
                const target = e.target;
                if (target.classList.contains('task-status')) {
                    const row = target.closest('tr');
                    const reportId = row.dataset.reportId;
                    const taskIndex = parseInt(row.dataset.taskIndex, 10);
                    updateTaskStatus(reportId, taskIndex, target.value);
                }
            });
        };
        
        /**
         * Gets the status color class for a given status.
         * @param {string} status - The task status.
         * @returns {string} The Tailwind CSS class for the status color.
         */
        const getStatusColorClass = (status) => {
            switch (status) {
                case 'Done': return 'bg-green-100 text-green-800';
                case 'Pending Approval': return 'bg-orange-100 text-orange-800';
                case 'Work in Progress': return 'bg-yellow-100 text-yellow-800';
                case 'Not Yet Started': return 'bg-blue-100 text-blue-800';
                default: return '';
            }
        };

        // --- MAIN INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Display today's date
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDateEl.textContent = today.toLocaleDateString('en-US', options);

            // Initial UI state
            showLoading("Initializing application...");
            setupEventListeners();
            initializeFirebase();
        });
    </script>
</body>
</html>
